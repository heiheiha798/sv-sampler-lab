# 高性能SystemVerilog约束BDD求解器

本项目是一个为SystemVerilog约束设计的高性能求解器。它能够解析复杂的约束条件，通过一系列创新的转换和优化步骤，最终生成满足所有约束的有效赋值解。该项目在处理大规模问题时表现出色，并在多个优化测试集上取得了优异的成绩。

## 项目亮点

- **创新的两阶段求解流程**：将问题分解为前端Verilog生成和后端BDD求解，实现了模块化和高效处理。
- **高级约束分析与优化**：在前端对约束进行深度分析，包括常量折叠、逻辑化简以及利用并查集（DSU）对约束进行分组，显著降低了后端处理的复杂度。
- **智能BDD变量排序**：实现了一种基于AIG拓扑结构的启发式变量排序算法，有效控制了BDD节点数量的增长，这是BDD求解性能的关键。
- **精确的加权随机采样**：通过动态规划计算BDD路径权重，并使用`__float128`高精度浮点数进行处理，确保在海量解空间中也能进行公平且准确的随机采样。

## 核心技术与实现

### 1. 前端：约束分析与Verilog生成 (`json_v_converter.cpp`)

前端负责将输入的JSON格式约束转换为结构化的Verilog代码。此阶段不仅是简单的格式转换，更包含了多项关键优化：

- **常量传播与化简**：在转换前，代码会预先计算和化简常量表达式（例如 `x && 1` -> `x`），并识别出永真或永假的约束，从而避免在后续步骤中进行不必要的工作。
- **基于并查集（DSU）的约束划分**：通过分析变量在不同约束之间的共享关系，使用并查集算法将庞大的约束集划分为多个独立的、不相交的组件。这一步骤极大地降低了问题的规模，使得后续可以对每个小组件独立求解，有效避免了BDD规模的指数级爆炸。
- **约束排序优化**：在每个独立的组件内部，根据约束的依赖关系和复杂度进行排序，以期生成对后续逻辑综合工具（如Yosys）更友好的Verilog代码，从而提升AIG的生成质量。

### 2. 后端：AIG到BDD的转换与求解 (`aig_bdd_solver.cpp`)

后端是求解器的核心，负责从Verilog代码生成最终解。

- **逻辑综合与AIG**：我们利用Yosys等工业级逻辑综合工具，将前端生成的Verilog代码高效地转换为与非门图（AIG），这是一种简洁、标准的逻辑表示形式。
- **BDD构建与变量排序**：
    - **构建**：使用经典的CUDD库将AIG转换为二元决策图（BDD）。
    - **静态变量排序**：BDD的节点数量对变量顺序高度敏感。我们没有采用CUDD库的默认排序，而是实现了一种基于AIG拓扑结构的深度优先遍历启发式算法 (`determine_bdd_variable_order`)。该算法优先处理依赖关系更紧密的变量，从源头上为构建一个更紧凑的BDD打下基础。
    - **动态变量重排**：同时，我们也启用了CUDD的动态变量重排功能 (`Cudd_AutodynEnable`)，作为静态排序的补充，在BDD构建过程中进一步优化变量顺序。
- **基于路径计数的加权随机采样**：
    - 为了从BDD代表的巨大解空间中随机采样，我们首先通过一次动态规划（记忆化递归）遍历BDD，计算出每个节点通往“真”叶节点的路径数量。
    - 考虑到解的数量可能超过标准64位整数的表示范围，我们采用了`__float128`高精度浮点数来存储路径计数，保证了计数的准确性。
    - 在采样时，从根节点出发，根据左右子树的路径计数的比例进行加权随机选择，最终得到一个完全随机且合法的解。

## 如何运行

1.  **编译代码**:
    ```bash
    bash build.sh
    ```

2.  **运行评估脚本**:
    可以对所有测试集或单个测试集进行评估。
    ```bash
    # 评测对应的部分或者全部测试用例
    ./evaluate.sh [basic|opt1|opt2|opt3|opt4|opt5|all]
    ```

---

注：本项目核心算法与代码实现主要由 Gemini 2.5 Pro 生成。
